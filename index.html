<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PECS Board Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* åŸºæœ¬è¨­å®š */
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f3f4f6;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .pecs-card {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .pecs-card:active { transform: scale(0.96); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* ãƒ”ãƒ³ç•™ã‚ãƒãƒ¼ã‚¯ */
        .pin-badge {
            position: absolute; top: 4px; left: 4px;
            color: #F59E0B; font-size: 14px;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
            z-index: 10;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ï¼ˆæ ç·šã¨èƒŒæ™¯ï¼‰ */
        .cat-require { border: 3px solid #F59E0B; background: #FFFBEB; } /* è¦æ±‚ï¼ˆé»„è‰²ï¼‰ */
        .cat-life { border: 2px solid #10B981; background: #ECFDF5; } /* ç”Ÿæ´»ï¼ˆç·‘ï¼‰ */
        .cat-food { border: 2px solid #EF4444; background: #FEF2F2; } /* é£Ÿäº‹ï¼ˆèµ¤ï¼‰ */
        .cat-play { border: 2px solid #3B82F6; background: #EFF6FF; } /* éŠã³ï¼ˆé’ï¼‰ */
        .cat-feeling { border: 2px solid #8B5CF6; background: #F5F3FF; } /* æ°—æŒã¡ï¼ˆç´«ï¼‰ */
        .cat-other { border: 2px solid #6B7280; background: #F9FAFB; } /* ãã®ä»–ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */

        /* å†ç”Ÿä¸­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .playing-highlight {
            border-color: #EF4444 !important;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
            transform: scale(1.02);
            z-index: 20;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s; }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.9); color: white;
            padding: 10px 20px; rounded-full: 99px;
            font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideUp 0.3s ease-out;
            z-index: 9999; pointer-events: none;
        }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆJSã§ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆï¼‰ */
        .grid-size-large { grid-template-columns: repeat(3, 1fr); }
        .grid-size-medium { grid-template-columns: repeat(4, 1fr); }
        .grid-size-small { grid-template-columns: repeat(5, 1fr); }
        @media (max-width: 640px) {
            .grid-size-large { grid-template-columns: repeat(2, 1fr); }
            .grid-size-medium { grid-template-columns: repeat(3, 1fr); }
            .grid-size-small { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="bg-white p-2 shadow-sm z-10 flex-none border-b border-gray-200">
        <div class="flex items-center justify-between mb-2 px-1">
            <div class="flex items-center gap-2">
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-gray-700 p-1">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-lg font-bold text-gray-700">PECS Pro</h1>
                <span id="modeBadge" class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 font-bold">å¤§äºº</span>
            </div>
            <div class="flex gap-2">
                <button onclick="togglePinFilter()" id="pinFilterBtn" class="text-gray-400 hover:text-yellow-500 p-2 rounded-full border border-transparent hover:bg-yellow-50 transition-colors">
                    <i class="fas fa-star text-lg"></i>
                </button>
                <button onclick="openCardModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-sm transition-transform active:scale-95 flex items-center gap-1">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">ä½œã‚‹</span>
                </button>
            </div>
        </div>
        <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1 px-1" id="categoryBar"></div>
    </header>

    <div id="settingsMenu" class="fixed inset-0 bg-black/50 hidden z-50" onclick="if(event.target===this) toggleSettings()">
        <div class="absolute left-0 top-0 bottom-0 w-80 bg-white shadow-xl transform transition-transform duration-300 -translate-x-full" id="settingsPanel">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>è¨­å®šãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <button onclick="toggleSettings()" class="text-gray-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-6 overflow-y-auto h-full pb-20">
                
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</h3>
                    <div class="flex bg-gray-200 rounded-lg p-1">
                        <button onclick="setMode('child')" id="modeChildBtn" class="flex-1 py-1.5 rounded-md text-sm font-bold transition-colors">ã²ã‚‰ãŒãªï¼ˆå…ç«¥ï¼‰</button>
                        <button onclick="setMode('adult')" id="modeAdultBtn" class="flex-1 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm transition-colors">æ¼¢å­—ï¼ˆå¤§äººï¼‰</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">ã‚«ãƒ¼ãƒ‰ã®å¤§ãã•</h3>
                    <div class="flex gap-2">
                        <button onclick="setGridSize('large')" class="flex-1 py-2 border rounded hover:bg-gray-50 text-sm">å¤§</button>
                        <button onclick="setGridSize('medium')" class="flex-1 py-2 border rounded hover:bg-gray-50 text-sm">ä¸­</button>
                        <button onclick="setGridSize('small')" class="flex-1 py-2 border rounded hover:bg-gray-50 text-sm">å°</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">ä¸¦ã³é †</h3>
                    <select id="sortOrder" onchange="changeSort(this.value)" class="w-full p-2 border rounded bg-white">
                        <option value="default">æ¨™æº–ï¼ˆãƒ”ãƒ³ç•™ã‚å„ªå…ˆï¼‰</option>
                        <option value="aiueo">ã‚ã„ã†ãˆãŠé †</option>
                        <option value="category">ã‚«ãƒ†ã‚´ãƒªé †</option>
                        <option value="frequency">ã‚ˆãä½¿ã†é †</option>
                    </select>
                </div>

                <div class="border-t pt-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div class="space-y-2">
                        <button onclick="exportData()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
                            <i class="fas fa-file-export text-blue-500"></i> ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿å­˜ï¼‰
                        </button>
                        <label class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2 cursor-pointer">
                            <i class="fas fa-file-import text-green-500"></i> å¾©å…ƒï¼ˆèª­ã¿è¾¼ã¿ï¼‰
                            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(this)">
                        </label>
                        <button onclick="resetAllData()" class="w-full text-left px-3 py-2 hover:bg-red-50 rounded text-sm flex items-center gap-2 text-red-600">
                            <i class="fas fa-trash-alt"></i> å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-2 bg-gray-100" id="mainContainer">
        <div id="cardGrid" class="grid gap-2 pb-32 transition-all duration-300"></div>
        
        <div id="emptyState" class="hidden flex-col items-center justify-center mt-20 text-gray-400">
            <i class="fas fa-box-open text-5xl mb-3 opacity-50"></i>
            <p class="text-sm font-bold">è¡¨ç¤ºã§ãã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <button onclick="openCardModal()" class="mt-4 text-blue-500 text-sm hover:underline">æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹</button>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 flex-shrink-0 z-20 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
        <div class="flex items-center px-2 py-3 gap-2 bg-gray-50 overflow-x-auto hide-scrollbar min-h-[100px] relative border-b border-gray-100" id="sentenceStrip">
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-300 font-bold text-sm" id="stripPlaceholder">
                <i class="far fa-hand-point-up mr-2"></i>ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„
            </div>
        </div>

        <div class="grid grid-cols-5 gap-1 p-2 bg-white">
            <button onclick="popLastCard()" class="col-span-1 py-3 rounded-lg border border-gray-200 text-gray-500 active:bg-gray-100 flex flex-col items-center justify-center">
                <i class="fas fa-backspace mb-0.5"></i>
                <span class="text-[10px] font-bold">1ã¤æ¶ˆã™</span>
            </button>
            <button onclick="clearStrip()" class="col-span-1 py-3 rounded-lg border border-red-100 text-red-400 active:bg-red-50 flex flex-col items-center justify-center">
                <i class="fas fa-trash-alt mb-0.5"></i>
                <span class="text-[10px] font-bold">ãœã‚“ã¶</span>
            </button>
            <button onclick="playSentence()" id="playBtn" class="col-span-3 py-3 rounded-lg bg-blue-600 text-white shadow-md active:bg-blue-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                <i class="fas fa-volume-up text-xl"></i>
                <span class="text-lg font-bold">ã¤ãŸãˆã‚‹</span>
            </button>
        </div>
    </footer>

    <div id="cardModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl w-full max-w-sm flex flex-col max-h-[90vh] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="bg-gray-800 text-white p-3 font-bold flex justify-between items-center">
                <span id="modalTitle">ã‚«ãƒ¼ãƒ‰ç·¨é›†</span>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 space-y-4">
                <div class="relative w-full aspect-square bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors cursor-pointer overflow-hidden group">
                    <input type="file" id="imgInput" accept="image/*" class="absolute inset-0 opacity-0 z-10 w-full h-full cursor-pointer" onchange="handleImage(this)">
                    <div id="previewArea" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-gray-400">
                        <i class="fas fa-camera text-3xl mb-1"></i>
                        <span class="text-xs font-bold">å†™çœŸã‚’å¤‰æ›´</span>
                    </div>
                    <img id="previewImg" class="absolute inset-0 w-full h-full object-contain bg-white hidden">
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">åå‰ï¼ˆæ¼¢å­—ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰<span class="text-red-500">*</span></label>
                        <input type="text" id="inputLabel" class="w-full p-2 border rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none" placeholder="ä¾‹: ãŠã‚„ã¤">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">èª­ã¿ãŒãªï¼ˆå…ç«¥ãƒ¢ãƒ¼ãƒ‰ãƒ»éŸ³å£°ç”¨ï¼‰</label>
                        <input type="text" id="inputTalk" class="w-full p-2 border rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none" placeholder="ä¾‹: ãŠã‚„ã¤">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="inputCat" class="w-full p-2 border rounded bg-white"></select>
                    </div>
                    <div class="flex items-center gap-2 pt-1">
                        <input type="checkbox" id="inputPin" class="w-4 h-4 text-blue-600 rounded">
                        <label for="inputPin" class="text-sm font-bold text-gray-700">ãŠæ°—ã«å…¥ã‚Šï¼ˆãƒ”ãƒ³ç•™ã‚ï¼‰</label>
                    </div>
                </div>
            </div>
            <div class="p-3 bg-gray-50 border-t flex gap-2">
                <button id="delBtn" onclick="deleteCard()" class="px-3 py-2 text-red-500 bg-white border border-gray-200 rounded hover:bg-red-50 hidden"><i class="fas fa-trash-alt"></i></button>
                <button onclick="saveCard()" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 shadow-sm">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="toastArea"></div>

    <script>
        // --- è¨­å®šãƒ»å®šæ•° ---
        const DB_KEY = 'pecs_pro_v5';
        const CONFIG_KEY = 'pecs_config_v1';
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        let config = {
            mode: 'adult', // child | adult
            gridSize: 'medium', // small | medium | large
            sort: 'default' // default | aiueo | category | frequency
        };

        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let cards = [];
        let categories = [];
        let sentenceStrip = [];
        let currentFilter = 'all';
        let isPinFilter = false;
        
        // ç·¨é›†ç”¨ä¸€æ™‚å¤‰æ•°
        let editingId = null;
        let tempImg = null;

        // éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ç”¨
        let isSpeaking = false;

        // --- åˆæœŸåŒ– ---
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadData();
            applyConfig();
            initSpeech();
            refreshUI();
        });

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if(saved) config = {...config, ...JSON.parse(saved)};
        }

        function saveConfig() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            applyConfig();
        }

        function loadData() {
            const raw = localStorage.getItem(DB_KEY);
            if(raw) {
                const data = JSON.parse(raw);
                cards = data.cards || [];
                categories = data.categories || [];
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç§»è¡Œãªã©ã®å‡¦ç†ãŒã‚ã‚Œã°ã“ã“ã«è¨˜è¿°
            } else {
                initDefaults();
            }
            // ä¸‡ãŒä¸€ã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã®å¾©æ—§
            if(categories.length === 0) initDefaults();
        }

        function saveData() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify({cards, categories}));
            } catch(e) {
                showToast('âš ï¸ å®¹é‡ãŒã„ã£ã±ã„ã§ä¿å­˜ã§ãã¾ã›ã‚“');
            }
        }

        // --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆGeminiã«ã‚ˆã‚‹æœ€é©åŒ–ï¼‰ ---
        function initDefaults() {
            // å®Ÿè·µçš„ãªã‚«ãƒ†ã‚´ãƒªåˆ†ã‘
            categories = [
                {id: 'require', label: 'ãŠã­ãŒã„', color: 'cat-require'},
                {id: 'life', label: 'ã›ã„ã‹ã¤', color: 'cat-life'},
                {id: 'food', label: 'ãŸã¹ã‚‚ã®', color: 'cat-food'},
                {id: 'play', label: 'ã‚ãã³', color: 'cat-play'},
                {id: 'feeling', label: 'ãã‚‚ã¡', color: 'cat-feeling'},
                {id: 'other', label: 'ãã®ã»ã‹', color: 'cat-other'}
            ];

            // å³é¸ã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆï¼ˆ1æšã§å®Œçµã™ã‚‹ã‚¿ã‚¤ãƒ—ã‚’å„ªå…ˆï¼‰
            const defaults = [
                // è¦æ±‚ï¼ˆæœ€é‡è¦ï¼‰
                {l:'ã€œãã ã•ã„', t:'ãã ã•ã„', c:'require', i:'ğŸ¤²', bg:'#FFFBEB', pin:true},
                {l:'æ‰‹ä¼ã£ã¦', t:'ã¦ã¤ã ã£ã¦', c:'require', i:'ğŸ¤', bg:'#FFFBEB', pin:true},
                {l:'ãŠã—ã¾ã„', t:'ãŠã—ã¾ã„', c:'require', i:'ğŸ™…', bg:'#FFFBEB'},
                {l:'ã‚ã¨ã§', t:'ã‚ã¨ã§', c:'require', i:'â³', bg:'#FFFBEB'},
                
                // ç”Ÿæ´»ï¼ˆ1æšå®Œçµï¼‰
                {l:'ãƒˆã‚¤ãƒ¬', t:'ã¨ã„ã‚Œã«ã„ãã¾ã™', c:'life', i:'ğŸš½', bg:'#ECFDF5', pin:true},
                {l:'ãŠé¢¨å‘‚', t:'ãŠãµã‚ã«ã¯ã„ã‚Šã¾ã™', c:'life', i:'ğŸ›', bg:'#ECFDF5'},
                {l:'æ‰‹æ´—ã„', t:'ã¦ã‚’ã‚ã‚‰ã„ã¾ã™', c:'life', i:'ğŸ§¼', bg:'#ECFDF5'},
                {l:'ç€æ›¿ãˆ', t:'ããŒãˆã¾ã™', c:'life', i:'ğŸ‘•', bg:'#ECFDF5'},
                {l:'å¯ã‚‹', t:'ã­ã¾ã™', c:'life', i:'ğŸ’¤', bg:'#ECFDF5'},
                
                // é£Ÿäº‹
                {l:'ãŠã‚„ã¤', t:'ãŠã‚„ã¤', c:'food', i:'ğŸª', bg:'#FEF2F2'},
                {l:'ã”ã¯ã‚“', t:'ã”ã¯ã‚“', c:'food', i:'ğŸš', bg:'#FEF2F2'},
                {l:'æ°´', t:'ã¿ãš', c:'food', i:'ğŸ’§', bg:'#FEF2F2'},
                {l:'ã‚¸ãƒ¥ãƒ¼ã‚¹', t:'ã˜ã‚…ãƒ¼ã™', c:'food', i:'ğŸ§ƒ', bg:'#FEF2F2'},
                
                // éŠã³
                {l:'YouTube', t:'ã‚†ãƒ¼ã¡ã‚…ãƒ¼ã¶', c:'play', i:'â–¶ï¸', bg:'#EFF6FF'},
                {l:'iPad', t:'ã‚ã„ã±ã£ã©', c:'play', i:'ğŸ“±', bg:'#EFF6FF'},
                {l:'ãŠã‚‚ã¡ã‚ƒ', t:'ãŠã‚‚ã¡ã‚ƒ', c:'play', i:'ğŸ§¸', bg:'#EFF6FF'},
                {l:'å…¬åœ’', t:'ã“ã†ãˆã‚“', c:'play', i:'ğŸ›', bg:'#EFF6FF'},
                
                // æ°—æŒã¡ãƒ»äºº
                {l:'ç—›ã„', t:'ã„ãŸã„ã§ã™', c:'feeling', i:'ğŸ¤•', bg:'#F5F3FF', pin:true},
                {l:'ã‚¤ãƒ¤', t:'ã„ã‚„ã§ã™', c:'feeling', i:'ğŸ˜ ', bg:'#F5F3FF'},
                {l:'æ¥½ã—ã„', t:'ãŸã®ã—ã„', c:'feeling', i:'ğŸ˜„', bg:'#F5F3FF'},
                {l:'ãŠæ¯ã•ã‚“', t:'ãŠã‹ã‚ã•ã‚“', c:'feeling', i:'ğŸ‘©', bg:'#F5F3FF'},
                {l:'å…ˆç”Ÿ', t:'ã›ã‚“ã›ã„', c:'feeling', i:'ğŸ§‘â€ğŸ«', bg:'#F5F3FF'}
            ];

            cards = defaults.map((d, i) => ({
                id: 'def_' + i,
                label: d.l,
                talk: d.t,
                category: d.c,
                image: createIcon(d.i, d.bg),
                isDefault: true,
                pin: d.pin || false,
                useCount: 0,
                timestamp: Date.now()
            }));
            saveData();
        }

        // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒç”Ÿæˆï¼ˆCanvasã§ãƒªãƒƒãƒã«ï¼‰
        function createIcon(icon, bg) {
            const cvs = document.createElement('canvas');
            cvs.width = 300; cvs.height = 300;
            const ctx = cvs.getContext('2d');
            
            // èƒŒæ™¯
            ctx.fillStyle = bg;
            ctx.fillRect(0,0,300,300);
            
            // ã‚¢ã‚¤ã‚³ãƒ³
            ctx.font = '160px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // å½±ã‚’ã¤ã‘ã¦è¦–èªæ€§ã‚¢ãƒƒãƒ—
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 5;
            ctx.fillText(icon, 150, 150);
            
            return cvs.toDataURL('image/jpeg', 0.8);
        }

        // --- UIãƒ­ã‚¸ãƒƒã‚¯ ---
        function applyConfig() {
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
            const body = document.body;
            const modeBadge = document.getElementById('modeBadge');
            const btnChild = document.getElementById('modeChildBtn');
            const btnAdult = document.getElementById('modeAdultBtn');

            if(config.mode === 'child') {
                modeBadge.textContent = 'ã²ã‚‰ãŒãª';
                modeBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-green-600 font-bold";
                btnChild.className = "flex-1 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm text-green-600 transition-colors";
                btnAdult.className = "flex-1 py-1.5 rounded-md text-sm font-bold text-gray-500 transition-colors";
            } else {
                modeBadge.textContent = 'å¤§äºº';
                modeBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 font-bold";
                btnChild.className = "flex-1 py-1.5 rounded-md text-sm font-bold text-gray-500 transition-colors";
                btnAdult.className = "flex-1 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm text-blue-600 transition-colors";
            }

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
            const grid = document.getElementById('cardGrid');
            grid.className = `grid gap-2 pb-32 transition-all duration-300 grid-size-${config.gridSize}`;
            
            // ã‚½ãƒ¼ãƒˆé¸æŠçŠ¶æ…‹
            document.getElementById('sortOrder').value = config.sort;
        }

        function refreshUI() {
            renderCategories();
            renderCards();
            renderStrip();
        }

        function renderCategories() {
            const bar = document.getElementById('categoryBar');
            const list = [{id:'all', label:'ãœã‚“ã¶'}, ...categories];
            
            bar.innerHTML = list.map(c => {
                const active = currentFilter === c.id;
                const baseClass = "px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all";
                const activeClass = "bg-gray-800 text-white border-gray-800 shadow-md";
                const inactiveClass = "bg-white text-gray-600 border-gray-200 hover:bg-gray-50";
                
                return `<button onclick="setFilter('${c.id}')" class="${baseClass} ${active ? activeClass : inactiveClass}">${c.label}</button>`;
            }).join('');
        }

        function renderCards() {
            const grid = document.getElementById('cardGrid');
            const empty = document.getElementById('emptyState');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let list = cards.filter(c => {
                if(isPinFilter && !c.pin) return false;
                if(currentFilter !== 'all' && c.category !== currentFilter) return false;
                return true;
            });

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯
            list.sort((a, b) => {
                // 1. ãƒ”ãƒ³ç•™ã‚å„ªå…ˆï¼ˆè¨­å®šã§å¤‰æ›´å¯èƒ½ã ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã“ã‚Œï¼‰
                if(config.sort === 'default') {
                    if(a.pin && !b.pin) return -1;
                    if(!a.pin && b.pin) return 1;
                    return b.timestamp - a.timestamp; // æ–°ã—ã„é †
                }
                // 2. äº”åéŸ³
                if(config.sort === 'aiueo') {
                    return a.talk.localeCompare(b.talk, 'ja');
                }
                // 3. ã‚«ãƒ†ã‚´ãƒª
                if(config.sort === 'category') {
                    if(a.category !== b.category) return a.category.localeCompare(b.category);
                    return 0;
                }
                // 4. é »åº¦
                if(config.sort === 'frequency') {
                    return (b.useCount||0) - (a.useCount||0);
                }
                return 0;
            });

            if(list.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden'); empty.classList.add('flex');
                return;
            }
            empty.classList.add('hidden'); empty.classList.remove('flex');

            grid.innerHTML = list.map(c => {
                // ã‚«ãƒ†ã‚´ãƒªè‰²å–å¾—
                const catObj = categories.find(cat => cat.id === c.category) || {color:'cat-other'};
                // è¡¨ç¤ºåï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ†å²ï¼‰
                const dispName = (config.mode === 'child') ? c.talk : c.label;

                return `
                <div class="pecs-card bg-white rounded-xl overflow-hidden flex flex-col ${catObj.color} aspect-[3/4]" onclick="addToStrip('${c.id}')">
                    ${c.pin ? '<i class="fas fa-star pin-badge"></i>' : ''}
                    <div class="absolute top-1 right-1 z-10">
                        <button onclick="event.stopPropagation(); openEditModal('${c.id}')" class="w-6 h-6 bg-white/80 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-500 shadow-sm border border-gray-100">
                            <i class="fas fa-ellipsis-h text-xs"></i>
                        </button>
                    </div>
                    <div class="flex-1 bg-white p-1 flex items-center justify-center overflow-hidden">
                        <img src="${c.image}" class="w-full h-full object-contain pointer-events-none">
                    </div>
                    <div class="h-8 flex items-center justify-center bg-white/90 border-t border-gray-100 px-1">
                        <span class="text-xs font-bold text-center truncate w-full">${dispName}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStrip() {
            const strip = document.getElementById('sentenceStrip');
            const ph = document.getElementById('stripPlaceholder');
            
            // ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚¯ãƒªã‚¢
            const items = strip.querySelectorAll('.strip-item');
            items.forEach(e => e.remove());

            if(sentenceStrip.length === 0) {
                ph.style.display = 'flex';
                return;
            }
            ph.style.display = 'none';

            sentenceStrip.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = "strip-item flex-shrink-0 w-20 bg-white rounded-lg border border-gray-300 shadow-sm overflow-hidden flex flex-col cursor-pointer animate-in fade-in zoom-in duration-200";
                div.id = `strip-${idx}`;
                div.onclick = () => removeStripItem(idx);
                
                const dispName = (config.mode === 'child') ? c.talk : c.label;
                
                div.innerHTML = `
                    <div class="flex-1 p-1 flex items-center justify-center">
                        <img src="${c.image}" class="max-w-full max-h-full object-contain">
                    </div>
                    <div class="h-6 bg-gray-50 flex items-center justify-center text-[10px] font-bold truncate px-1">
                        ${dispName}
                    </div>
                `;
                strip.appendChild(div);
            });
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => strip.scrollTo({left: strip.scrollWidth, behavior:'smooth'}), 50);
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function setFilter(id) {
            currentFilter = id;
            isPinFilter = false;
            document.getElementById('pinFilterBtn').classList.remove('text-yellow-500', 'bg-yellow-50');
            refreshUI();
        }

        function togglePinFilter() {
            isPinFilter = !isPinFilter;
            const btn = document.getElementById('pinFilterBtn');
            if(isPinFilter) btn.classList.add('text-yellow-500', 'bg-yellow-50');
            else btn.classList.remove('text-yellow-500', 'bg-yellow-50');
            refreshUI();
        }

        function addToStrip(id) {
            const c = cards.find(x => x.id === id);
            if(c) {
                // ä½¿ç”¨ã‚«ã‚¦ãƒ³ãƒˆåŠ ç®—
                c.useCount = (c.useCount || 0) + 1;
                saveData(); // ã‚«ã‚¦ãƒ³ãƒˆä¿å­˜
                
                sentenceStrip.push({...c});
                renderStrip();
                // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                if(navigator.vibrate) navigator.vibrate(5);
            }
        }

        function removeStripItem(idx) {
            sentenceStrip.splice(idx, 1);
            renderStrip();
        }
        function popLastCard() {
            sentenceStrip.pop();
            renderStrip();
        }
        function clearStrip() {
            if(sentenceStrip.length > 0 && confirm('ãœã‚“ã¶æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sentenceStrip = [];
                renderStrip();
            }
        }

        // --- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£ ---
        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            const panel = document.getElementById('settingsPanel');
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('-translate-x-full'), 10);
            } else {
                panel.classList.add('-translate-x-full');
                setTimeout(() => menu.classList.add('hidden'), 300);
            }
        }

        function setMode(m) {
            config.mode = m;
            saveConfig();
        }
        function setGridSize(s) {
            config.gridSize = s;
            saveConfig();
        }
        function changeSort(val) {
            config.sort = val;
            saveConfig();
            refreshUI(); // å³æ™‚åæ˜ 
        }

        // --- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
        function exportData() {
            const data = {cards, categories, config, version: 'pro_v5'};
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pecs_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                        cards = data.cards || [];
                        // ã‚«ãƒ†ã‚´ãƒªã¯IDäº’æ›æ€§ã®ãŸã‚ãƒãƒ¼ã‚¸æ¨å¥¨ã ãŒä»Šå›ã¯ä¸Šæ›¸ã
                        if(data.categories) categories = data.categories;
                        if(data.config) config = data.config;
                        saveData();
                        saveConfig();
                        refreshUI();
                        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                    }
                } catch(err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹ã‹å½¢å¼ãŒé•ã„ã¾ã™');
                }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if(confirm('ã€è­¦å‘Šã€‘\nã™ã¹ã¦ã®è‡ªä½œã‚«ãƒ¼ãƒ‰ã‚„è¨­å®šãŒæ¶ˆãˆã¾ã™ã€‚\nåˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(DB_KEY);
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- ã‚«ãƒ¼ãƒ‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        function openCardModal() {
            editingId = null; tempImg = null;
            document.getElementById('cardModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = "æ–°ã—ã„ã‚«ãƒ¼ãƒ‰";
            document.getElementById('inputLabel').value = '';
            document.getElementById('inputTalk').value = '';
            document.getElementById('inputPin').checked = false;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('previewImg').classList.add('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            document.getElementById('delBtn').classList.add('hidden');
            
            renderCatSelect();
        }

        function openEditModal(id) {
            const c = cards.find(x => x.id === id);
            editingId = id; tempImg = c.image;
            document.getElementById('cardModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = "ã‚«ãƒ¼ãƒ‰ç·¨é›†";
            
            document.getElementById('inputLabel').value = c.label;
            document.getElementById('inputTalk').value = c.talk;
            document.getElementById('inputPin').checked = c.pin || false;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const img = document.getElementById('previewImg');
            img.src = c.image;
            img.classList.remove('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‰Šé™¤ä¸å¯ã«ã™ã‚‹ã‹è­¦å‘Šä»˜ãã«ã™ã‚‹ã‹ï¼‰
            const delBtn = document.getElementById('delBtn');
            delBtn.classList.remove('hidden');
            if(c.isDefault) delBtn.disabled = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚‚æ¶ˆã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆè¦æœ›ã®è‡ªç”±åº¦ç¢ºä¿ï¼‰

            renderCatSelect(c.category);
        }

        function closeModal() {
            document.getElementById('cardModal').classList.add('hidden');
        }

        function renderCatSelect(selId) {
            const sel = document.getElementById('inputCat');
            sel.innerHTML = categories.map(c => `<option value="${c.id}" ${c.id===selId?'selected':''}>${c.label}</option>`).join('');
        }

        function handleImage(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                resizeImage(e.target.result, res => {
                    tempImg = res;
                    const img = document.getElementById('previewImg');
                    img.src = res;
                    img.classList.remove('hidden');
                    document.getElementById('previewArea').classList.add('hidden');
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        // èƒŒæ™¯ç™½å¡—ã‚Šã¤ã¶ã—ãƒªã‚µã‚¤ã‚º
        function resizeImage(base64, cb) {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const MAX = 400; // å°‘ã—ç”»è³ªè½ã¨ã™
                let w=img.width, h=img.height;
                if(w>h){if(w>MAX){h*=MAX/w;w=MAX}}else{if(h>MAX){w*=MAX/h;h=MAX}}
                cvs.width=w; cvs.height=h;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle='#FFF'; ctx.fillRect(0,0,w,h);
                ctx.drawImage(img,0,0,w,h);
                cb(cvs.toDataURL('image/jpeg', 0.7));
            }
        }

        function saveCard() {
            const lbl = document.getElementById('inputLabel').value.trim();
            let tlk = document.getElementById('inputTalk').value.trim();
            const cat = document.getElementById('inputCat').value;
            const pin = document.getElementById('inputPin').checked;

            if(!lbl) return alert('åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„');
            if(!tempImg) return alert('ç”»åƒã‚’è¨­å®šã—ã¦ãã ã•ã„');
            if(!tlk) tlk = lbl; // èª­ã¿çœç•¥æ™‚ã¯åå‰ã‚’ä½¿ç”¨

            const newData = {
                id: editingId || 'usr_' + Date.now(),
                label: lbl,
                talk: tlk,
                category: cat,
                image: tempImg,
                pin: pin,
                isDefault: editingId ? (cards.find(c=>c.id===editingId)?.isDefault||false) : false,
                useCount: editingId ? (cards.find(c=>c.id===editingId)?.useCount||0) : 0,
                timestamp: Date.now()
            };

            if(editingId) {
                cards = cards.map(c => c.id === editingId ? newData : c);
            } else {
                cards.push(newData);
            }
            saveData();
            closeModal();
            refreshUI();
            showToast('ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function deleteCard() {
            if(confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                cards = cards.filter(c => c.id !== editingId);
                saveData();
                closeModal();
                refreshUI();
                showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // --- éŸ³å£°å†ç”Ÿï¼ˆãƒ—ãƒ­ä»•æ§˜ï¼‰ ---
        function initSpeech() {
            if('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
            }
        }

        function playSentence() {
            if(sentenceStrip.length === 0 || isSpeaking) return;

            isSpeaking = true;
            const btn = document.getElementById('playBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ã˜ã‚…ã‚“ã³...';
            btn.classList.add('bg-gray-500');

            // ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ã®ãŠã¾ã˜ãªã„ï¼ˆç„¡éŸ³å†ç”Ÿï¼‰
            window.speechSynthesis.cancel();
            const wake = new SpeechSynthesisUtterance('');
            window.speechSynthesis.speak(wake);

            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-volume-high animate-pulse"></i> ãŠã¯ãªã—ä¸­';
                speakRecursive(0, () => {
                    isSpeaking = false;
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-gray-500');
                    clearHighlights();
                });
            }, 500);
        }

        function speakRecursive(idx, onComplete) {
            if(idx >= sentenceStrip.length) {
                onComplete();
                return;
            }

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            clearHighlights();
            const el = document.getElementById(`strip-${idx}`);
            if(el) el.classList.add('playing-highlight');

            const card = sentenceStrip[idx];
            // ãƒ¢ãƒ¼ãƒ‰ã«é–¢ã‚ã‚‰ãšã€ŒéŸ³å£°ç”¨ãƒ†ã‚­ã‚¹ãƒˆ(talk)ã€ã‚’èª­ã‚€
            const txt = card.talk;

            const ut = new SpeechSynthesisUtterance(txt);
            ut.lang = 'ja-JP';
            ut.rate = 0.9;
            
            ut.onend = () => {
                // é–“éš”èª¿æ•´ï¼šè¦æ±‚ï¼ˆï½ãã ã•ã„ï¼‰ã®å¾Œã¯é•·ã
                const isReq = (card.category === 'require');
                setTimeout(() => speakRecursive(idx+1, onComplete), isReq ? 1500 : 400);
            };
            ut.onerror = () => {
                setTimeout(() => speakRecursive(idx+1, onComplete), 500);
            };

            window.speechSynthesis.speak(ut);
        }

        function clearHighlights() {
            document.querySelectorAll('.strip-item').forEach(e => e.classList.remove('playing-highlight'));
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function showToast(msg) {
            const area = document.getElementById('toastArea');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>